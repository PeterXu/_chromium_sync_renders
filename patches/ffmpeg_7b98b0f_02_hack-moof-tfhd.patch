From d767d33b5ccfcc8fe74fc6bdefc08b3383d360e9 Mon Sep 17 00:00:00 2001
From: Yongze Xu <yongzxu@ubuntu.(none)>
Date: Wed, 21 Jan 2015 22:04:58 -0800
Subject: [PATCH 1/2] add h264 demuxer for Chrome/linux/ia32&x64

---
 chromium/config/Chrome/linux/ia32/config.asm |    2 +-
 chromium/config/Chrome/linux/ia32/config.h   |    4 ++--
 chromium/config/Chrome/linux/x64/config.asm  |    2 +-
 chromium/config/Chrome/linux/x64/config.h    |    4 ++--
 ffmpeg_generated.gni                         |    1 +
 ffmpeg_generated.gypi                        |    1 +
 6 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/chromium/config/Chrome/linux/ia32/config.asm b/chromium/config/Chrome/linux/ia32/config.asm
index fc42a89..79d3418 100644
--- a/chromium/config/Chrome/linux/ia32/config.asm
+++ b/chromium/config/Chrome/linux/ia32/config.asm
@@ -1016,7 +1016,7 @@
 %define CONFIG_GXF_DEMUXER 0
 %define CONFIG_H261_DEMUXER 0
 %define CONFIG_H263_DEMUXER 0
-%define CONFIG_H264_DEMUXER 0
+%define CONFIG_H264_DEMUXER 1
 %define CONFIG_HEVC_DEMUXER 0
 %define CONFIG_HLS_DEMUXER 0
 %define CONFIG_HNM_DEMUXER 0
diff --git a/chromium/config/Chrome/linux/ia32/config.h b/chromium/config/Chrome/linux/ia32/config.h
index 5a2d3c9..268898a 100644
--- a/chromium/config/Chrome/linux/ia32/config.h
+++ b/chromium/config/Chrome/linux/ia32/config.h
@@ -1,7 +1,7 @@
 /* Automatically generated by configure - do not modify! */
 #ifndef FFMPEG_CONFIG_H
 #define FFMPEG_CONFIG_H
-#define FFMPEG_CONFIGURATION "--disable-everything --disable-all --disable-doc --disable-static --enable-avcodec --enable-avformat --enable-avutil --enable-fft --enable-rdft --enable-shared --disable-bzlib --disable-error-resilience --disable-iconv --disable-lzo --disable-network --disable-symver --disable-xlib --disable-zlib --disable-dxva2 --disable-vaapi --disable-vda --disable-vdpau --enable-decoder='theora,vorbis,vp8' --enable-decoder='pcm_u8,pcm_s16le,pcm_s24le,pcm_f32le' --enable-decoder='pcm_s16be,pcm_s24be,pcm_mulaw,pcm_alaw' --enable-demuxer='ogg,matroska,wav' --enable-parser='opus,vp3,vorbis,vp8' --optflags='\"-O2\"' --arch=i686 --enable-yasm --extra-cflags='\"-m32\"' --extra-ldflags='\"-m32\"' --enable-pic --enable-decoder='aac,h264,mp3' --enable-demuxer='aac,mp3,mov' --enable-parser='aac,h264,mpegaudio'"
+#define FFMPEG_CONFIGURATION "--disable-everything --disable-all --disable-doc --disable-static --enable-avcodec --enable-avformat --enable-avutil --enable-fft --enable-rdft --enable-shared --disable-bzlib --disable-error-resilience --disable-iconv --disable-lzo --disable-network --disable-symver --disable-xlib --disable-zlib --disable-dxva2 --disable-vaapi --disable-vda --disable-vdpau --enable-decoder='theora,vorbis,vp8' --enable-decoder='pcm_u8,pcm_s16le,pcm_s24le,pcm_f32le' --enable-decoder='pcm_s16be,pcm_s24be,pcm_mulaw,pcm_alaw' --enable-demuxer='ogg,matroska,wav' --enable-parser='opus,vp3,vorbis,vp8' --optflags='\"-O2\"' --arch=i686 --enable-yasm --extra-cflags='\"-m32\"' --extra-ldflags='\"-m32\"' --enable-pic --enable-decoder='aac,h264,mp3' --enable-demuxer='aac,mp3,mov,h264' --enable-parser='aac,h264,mpegaudio'"
 #define FFMPEG_LICENSE "LGPL version 2.1 or later"
 #define CONFIG_THIS_YEAR 2014
 #define FFMPEG_DATADIR "/usr/local/share/ffmpeg"
@@ -1032,7 +1032,7 @@
 #define CONFIG_GXF_DEMUXER 0
 #define CONFIG_H261_DEMUXER 0
 #define CONFIG_H263_DEMUXER 0
-#define CONFIG_H264_DEMUXER 0
+#define CONFIG_H264_DEMUXER 1
 #define CONFIG_HEVC_DEMUXER 0
 #define CONFIG_HLS_DEMUXER 0
 #define CONFIG_HNM_DEMUXER 0
diff --git a/chromium/config/Chrome/linux/x64/config.asm b/chromium/config/Chrome/linux/x64/config.asm
index 8203294..867896f 100644
--- a/chromium/config/Chrome/linux/x64/config.asm
+++ b/chromium/config/Chrome/linux/x64/config.asm
@@ -1016,7 +1016,7 @@
 %define CONFIG_GXF_DEMUXER 0
 %define CONFIG_H261_DEMUXER 0
 %define CONFIG_H263_DEMUXER 0
-%define CONFIG_H264_DEMUXER 0
+%define CONFIG_H264_DEMUXER 1
 %define CONFIG_HEVC_DEMUXER 0
 %define CONFIG_HLS_DEMUXER 0
 %define CONFIG_HNM_DEMUXER 0
diff --git a/chromium/config/Chrome/linux/x64/config.h b/chromium/config/Chrome/linux/x64/config.h
index 37b1d2c..b3a0cf0 100644
--- a/chromium/config/Chrome/linux/x64/config.h
+++ b/chromium/config/Chrome/linux/x64/config.h
@@ -1,7 +1,7 @@
 /* Automatically generated by configure - do not modify! */
 #ifndef FFMPEG_CONFIG_H
 #define FFMPEG_CONFIG_H
-#define FFMPEG_CONFIGURATION "--disable-everything --disable-all --disable-doc --disable-static --enable-avcodec --enable-avformat --enable-avutil --enable-fft --enable-rdft --enable-shared --disable-bzlib --disable-error-resilience --disable-iconv --disable-lzo --disable-network --disable-symver --disable-xlib --disable-zlib --disable-dxva2 --disable-vaapi --disable-vda --disable-vdpau --enable-decoder='theora,vorbis,vp8' --enable-decoder='pcm_u8,pcm_s16le,pcm_s24le,pcm_f32le' --enable-decoder='pcm_s16be,pcm_s24be,pcm_mulaw,pcm_alaw' --enable-demuxer='ogg,matroska,wav' --enable-parser='opus,vp3,vorbis,vp8' --optflags='\"-O2\"' --enable-pic --enable-decoder='aac,h264,mp3' --enable-demuxer='aac,mp3,mov' --enable-parser='aac,h264,mpegaudio'"
+#define FFMPEG_CONFIGURATION "--disable-everything --disable-all --disable-doc --disable-static --enable-avcodec --enable-avformat --enable-avutil --enable-fft --enable-rdft --enable-shared --disable-bzlib --disable-error-resilience --disable-iconv --disable-lzo --disable-network --disable-symver --disable-xlib --disable-zlib --disable-dxva2 --disable-vaapi --disable-vda --disable-vdpau --enable-decoder='theora,vorbis,vp8' --enable-decoder='pcm_u8,pcm_s16le,pcm_s24le,pcm_f32le' --enable-decoder='pcm_s16be,pcm_s24be,pcm_mulaw,pcm_alaw' --enable-demuxer='ogg,matroska,wav' --enable-parser='opus,vp3,vorbis,vp8' --optflags='\"-O2\"' --enable-pic --enable-decoder='aac,h264,mp3' --enable-demuxer='aac,mp3,mov,h264' --enable-parser='aac,h264,mpegaudio'"
 #define FFMPEG_LICENSE "LGPL version 2.1 or later"
 #define CONFIG_THIS_YEAR 2014
 #define FFMPEG_DATADIR "/usr/local/share/ffmpeg"
@@ -1032,7 +1032,7 @@
 #define CONFIG_GXF_DEMUXER 0
 #define CONFIG_H261_DEMUXER 0
 #define CONFIG_H263_DEMUXER 0
-#define CONFIG_H264_DEMUXER 0
+#define CONFIG_H264_DEMUXER 1
 #define CONFIG_HEVC_DEMUXER 0
 #define CONFIG_HLS_DEMUXER 0
 #define CONFIG_HNM_DEMUXER 0
diff --git a/ffmpeg_generated.gni b/ffmpeg_generated.gni
index 9aceb97..b9567b0 100644
--- a/ffmpeg_generated.gni
+++ b/ffmpeg_generated.gni
@@ -228,6 +228,7 @@ if (ffmpeg_branding == "Chrome" || ffmpeg_branding == "ChromeOS") {
     "libavcodec/startcode.c",
     "libavformat/aacdec.c",
     "libavformat/apetag.c",
+    "libavformat/h264dec.c",
     "libavformat/img2.c",
     "libavformat/mov.c",
     "libavformat/mov_chan.c",
diff --git a/ffmpeg_generated.gypi b/ffmpeg_generated.gypi
index dd6915e..b812ddc 100644
--- a/ffmpeg_generated.gypi
+++ b/ffmpeg_generated.gypi
@@ -299,6 +299,7 @@
           'libavcodec/startcode.c',
           'libavformat/aacdec.c',
           'libavformat/apetag.c',
+          'libavformat/h264dec.c',
           'libavformat/img2.c',
           'libavformat/mov.c',
           'libavformat/mov_chan.c',
-- 
1.7.9.5


From e18673977f1a79afd8344f5dd7f14eb82a988bd8 Mon Sep 17 00:00:00 2001
From: Yongze Xu <yongzxu@ubuntu.(none)>
Date: Sun, 25 Jan 2015 20:52:31 -0800
Subject: [PATCH 2/2] [ok] hack for moof/tfhd's data offset

---
 libavformat/mov.c |    3 +++
 1 file changed, 3 insertions(+)

diff --git a/libavformat/mov.c b/libavformat/mov.c
index 64c2c10..d4ae8f0 100644
--- a/libavformat/mov.c
+++ b/libavformat/mov.c
@@ -2879,6 +2879,9 @@ static int mov_read_tfhd(MOVContext *c, AVIOContext *pb, MOVAtom atom)
     frag->base_data_offset = flags & MOV_TFHD_BASE_DATA_OFFSET ?
                              avio_rb64(pb) : flags & MOV_TFHD_DEFAULT_BASE_IS_MOOF ?
                              frag->moof_offset : frag->implicit_offset;
+    // TODO fix combine of mulit-moov from differet files
+    frag->base_data_offset = flags & MOV_TFHD_DEFAULT_BASE_IS_MOOF ?
+                             frag->moof_offset : frag->implicit_offset;
     frag->stsd_id  = flags & MOV_TFHD_STSD_ID ? avio_rb32(pb) : trex->stsd_id;
 
     frag->duration = flags & MOV_TFHD_DEFAULT_DURATION ?
-- 
1.7.9.5

